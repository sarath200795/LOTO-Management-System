<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTO PRO - Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; }
        .glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .input-field { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 12px; width: 100%; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: #ef4444; background: rgba(255,255,255,0.08); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-red-600/20 rounded-full blur-[100px]"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-blue-600/20 rounded-full blur-[100px]"></div>

    <div id="auth-container" class="glass w-full max-w-md p-10 rounded-[32px] relative z-10 shadow-2xl">
        
        <div id="login-form">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black italic uppercase">LOTO<span class="text-red-600">PRO</span></h1>
                <p class="text-[10px] font-bold uppercase text-slate-500 tracking-[0.3em] mt-1">Secure Gateway</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="log-org" placeholder="ORGANIZATION ID" class="input-field" required>
                <input type="email" id="log-email" placeholder="EMAIL ADDRESS" class="input-field" required>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 py-4 rounded-xl font-black uppercase text-xs tracking-widest transition-all shadow-lg shadow-red-900/20">Sign In</button>
            </form>
            
            <div class="mt-8 pt-6 border-t border-white/5 text-center">
                <p class="text-[10px] text-slate-500 font-bold uppercase mb-2">New Organization or User?</p>
                <button onclick="toggleView('signup')" class="text-[10px] text-white font-black uppercase border border-white/10 px-4 py-2 rounded-full hover:bg-white/5 transition-all">Create / Join Account</button>
            </div>
        </div>

        <div id="signup-form" class="hidden">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-black italic uppercase text-white">Registration</h1>
                <p class="text-[10px] font-bold uppercase text-slate-500 tracking-[0.2em] mt-1">Join the network</p>
            </div>

            <form onsubmit="handleRegister(event)" class="space-y-4">
                <input type="text" id="reg-org" placeholder="ORGANIZATION ID (Unique)" class="input-field" required>
                <input type="text" id="reg-name" placeholder="FULL NAME" class="input-field" required>
                <input type="email" id="reg-email" placeholder="EMAIL ADDRESS" class="input-field" required>
                <select id="reg-role" class="input-field cursor-pointer">
                    <option value="User" class="bg-slate-900">Technician</option>
                    <option value="Manager" class="bg-slate-900">Manager</option>
                    <option value="Owner" class="bg-slate-900">Owner</option>
                </select>
                
                <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-500/20">
                    <p class="text-[9px] text-blue-300 leading-relaxed">
                        <span class="font-black">NOTE:</span> If this Organization ID is new, you will become the <b>OWNER</b> automatically. If it exists, your request will be sent to the Owner for approval.
                    </p>
                </div>

                <button type="submit" class="w-full bg-white text-black hover:bg-slate-200 py-4 rounded-xl font-black uppercase text-xs tracking-widest transition-all">Submit Request</button>
            </form>
            
            <div class="mt-6 text-center">
                <button onclick="toggleView('login')" class="text-[10px] text-slate-500 font-bold uppercase hover:text-white transition-all">Back to Login</button>
            </div>
        </div>

    </div>

    <script>
        const DB_URL = "https://loto-pro-f7417-default-rtdb.firebaseio.com";

        function toggleView(view) {
            document.getElementById('login-form').classList.toggle('hidden', view !== 'login');
            document.getElementById('signup-form').classList.toggle('hidden', view !== 'signup');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const org = document.getElementById('log-org').value.trim().toUpperCase();
            const email = document.getElementById('log-email').value.trim().toLowerCase();
            const btn = e.target.querySelector('button');
            
            btn.innerText = "VERIFYING...";
            
            try {
                // Fetch users for this Org
                const res = await fetch(`${DB_URL}/${org}/users.json`);
                const users = await res.json();
                
                // Find user match
                const user = users ? Object.values(users).find(u => u.email.toLowerCase() === email) : null;

                if (user) {
                    if (user.isAuthorized) {
                        // SUCCESS
                        sessionStorage.setItem("loto_org_id", org);
                        sessionStorage.setItem("loto_user_role", user.role);
                        sessionStorage.setItem("loto_user_name", user.name);
                        window.location.href = 'home.html';
                    } else {
                        alert("ACCOUNT PENDING: Your request has not been approved by the Organization Owner yet.");
                    }
                } else {
                    alert("ERROR: Account not found. Please check Organization ID and Email, or Register.");
                }
            } catch(err) {
                console.error(err);
                alert("Connection Error. Please check internet.");
            }
            btn.innerText = "SIGN IN";
        }

        async function handleRegister(e) {
            e.preventDefault();
            const orgId = document.getElementById('reg-org').value.trim().toUpperCase();
            const email = document.getElementById('reg-email').value.trim().toLowerCase();
            const name = document.getElementById('reg-name').value.trim();
            const requestedRole = document.getElementById('reg-role').value;
            
            // Check if Org exists by trying to fetch its user list
            const res = await fetch(`${DB_URL}/${orgId}/users.json`);
            const existingUsers = await res.json();
            
            let isFirstUser = false;
            if (!existingUsers) isFirstUser = true;

            // Logic: If first user -> Owner & Authorized. Else -> Requested Role & Unauthorized.
            const finalRole = isFirstUser ? "Owner" : requestedRole;
            const authorized = isFirstUser ? true : false;

            const newUser = {
                name: name,
                email: email,
                role: finalRole,
                isAuthorized: authorized,
                joined: new Date().toISOString()
            };

            // Push to Firebase (Using POST to generate unique key)
            await fetch(`${DB_URL}/${orgId}/users.json`, { 
                method: 'POST', 
                body: JSON.stringify(newUser) 
            });

            if (authorized) {
                alert(`SUCCESS: Organization '${orgId}' created. You are the Owner. Please Log In.`);
                toggleView('login');
            } else {
                alert(`REQUEST SENT: Access to '${orgId}' is pending Owner approval.`);
                toggleView('login');
            }
        }
    </script>
</body>
</html>
